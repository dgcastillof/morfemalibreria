rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /reviews/{slug}/comments/{commentId} {
      function isAdmin() {
        return request.auth != null && request.auth.token.admin == true;
      }

      allow read: if resource.data.approved == true || isAdmin();

      allow create: if
        request.resource.data.keys().hasOnly(['name', 'message', 'createdAt', 'recaptchaToken']) &&
        request.resource.data.name is string &&
        request.resource.data.message is string &&
        request.resource.data.name.size() > 0 && request.resource.data.name.size() <= 100 &&
        request.resource.data.message.size() > 0 && request.resource.data.message.size() <= 1000 &&
        request.time == request.resource.data.createdAt &&
        (!('recaptchaToken' in request.resource.data) || request.resource.data.recaptchaToken is string);

      allow update, delete: if isAdmin();
    }
  }
}
